## Flask æ–‡ä»¶ç®¡ç†ç³»ç»Ÿæ•™ç¨‹ï¼ˆæ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼‰## ç”¨é€”è¯´æ˜æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº Flask æ¡†æ¶å¼€å‘çš„æ–‡ä»¶ç®¡ç†å°å·¥å…·ï¼Œé€‚ç”¨äºä¸ªäººã€å°å‹å›¢é˜Ÿæˆ–å®¶åº­å±€åŸŸç½‘ç¯å¢ƒã€‚ä½ å¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡ç½‘é¡µä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤æ–‡ä»¶ï¼Œå¹¶æµè§ˆæ‰€æœ‰å·²ä¸Šä¼ çš„æ–‡ä»¶ã€‚**æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ **ï¼Œé€‚åˆæ—¥å¸¸æ–‡ä»¶å½’æ¡£ã€èµ„æ–™å…±äº«ç­‰åœºæ™¯ã€‚---## 1. é¡¹ç›®ç»“æ„
```
file_manager/
â”‚
â”œâ”€â”€ app.py
â”œâ”€â”€ uploads/               # å­˜å‚¨ä¸Šä¼ æ–‡ä»¶çš„ç›®å½•ï¼ˆéœ€æå‰åˆ›å»ºï¼‰
â””â”€â”€ templates/
    â””â”€â”€ file_manager.html  # ä¸»é¡µé¢HTMLæ¨¡æ¿
```
> æç¤ºï¼šè¯·è‡ªè¡Œåˆ›å»º `uploads/` æ–‡ä»¶å¤¹ï¼Œå¹¶ç¡®ä¿æœ‰å†™æƒé™ã€‚

---

## 2. ä¸»è¦åŠŸèƒ½

- **å¤šæ–‡ä»¶ä¸Šä¼ **ï¼šä¸€æ¬¡å¯é€‰æ‹©å¹¶ä¸Šä¼ å¤šä¸ªæ–‡ä»¶
- **æ–‡ä»¶ä¸‹è½½**ï¼šæ”¯æŒå•ä¸ªæ–‡ä»¶ä¸‹è½½
- **æ–‡ä»¶åˆ é™¤**ï¼šå¯é€ä¸ªåˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶
- **æ–‡ä»¶åˆ—è¡¨**ï¼šå±•ç¤ºæ‰€æœ‰å·²ä¸Šä¼ çš„æ–‡ä»¶

---

## 3. ä»£ç ä¸è®²è§£

### app.py

```python
from flask import Flask, request, render_template, send_from_directory, redirect, url_for, flash
import os

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = 'uploads'
app.secret_key = 'super_secret_key'

# ç¡®ä¿å­˜å‚¨ç›®å½•å­˜åœ¨
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)

@app.route('/', methods=['GET', 'POST'])
def file_manager():
    if request.method == 'POST':
        # å¤„ç†å¤šæ–‡ä»¶ä¸Šä¼ 
        files = request.files.getlist('files')
        if not files or files[0].filename == '':
            flash('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶')
            return redirect(request.url)
        for file in files:
            if file and file.filename:
                save_path = os.path.join(app.config['UPLOAD_FOLDER'], file.filename)
                file.save(save_path)
        flash('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ')
        return redirect(url_for('file_manager'))

    # æ–‡ä»¶åˆ—è¡¨å±•ç¤º
    files = os.listdir(app.config['UPLOAD_FOLDER'])
    return render_template('file_manager.html', files=files)

@app.route('/download/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename, as_attachment=True)

@app.route('/delete/<filename>')
def delete_file(filename):
    file_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    if os.path.exists(file_path):
        os.remove(file_path)
        flash(f'{filename} åˆ é™¤æˆåŠŸ')
    else:
        flash(f'{filename} ä¸å­˜åœ¨')
    return redirect(url_for('file_manager'))

if __name__ == '__main__':
    app.run(debug=True)
```

---

### templates/file_manager.html

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æ–‡ä»¶ç®¡ç†å™¨</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        .file-list { margin-top: 20px; }
        .file-item { padding: 5px 0; }
        .action-link { margin-left: 10px; }
        .flash-message { color: red; }
    </style>
</head>
<body>
    <h1>ç®€æ˜“æ–‡ä»¶ç®¡ç†å™¨</h1>
    <form id="upload-form" action="/" method="post" enctype="multipart/form-data">
        <label for="file-input">é€‰æ‹©æ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰ï¼š</label>
        <input id="file-input" type="file" name="files" multiple required>
        <button type="submit">ä¸Šä¼ </button>
    </form>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash-message">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="file-list">
        <h2>å·²ä¸Šä¼ æ–‡ä»¶</h2>
        <ul>
            {% for file in files %}
            <li class="file-item">
                {{ file }}
                <a class="action-link" href=" 'download_file', filename=file) }}">ä¸‹è½½</a >
                <a class="action-link" href="{{ url_for('delete_file', filename=file) }}" onclick="return confirm('ç¡®è®¤åˆ é™¤ {{ file }} å—ï¼Ÿ');">åˆ é™¤</a >
            </li>
            {% else %}
            <li>æš‚æ— æ–‡ä»¶</li>
            {% endfor %}
        </ul>
    </div>
</body>
</html>
```

---

## 4. å¯åŠ¨æ–¹æ³•

ç¡®ä¿åœ¨ `file_manager/` ç›®å½•ä¸‹ï¼Œç»ˆç«¯è¿è¡Œï¼š

```bash
python app.py
```

ç„¶ååœ¨æµè§ˆå™¨è¾“å…¥ [http://127.0.0.1:5000/](http://127.0.0.1:5000/) æ‰“å¼€é¡µé¢ã€‚

---

## 5. ä½¿ç”¨è¯´æ˜

- **ä¸Šä¼ **  
  ç‚¹å‡»â€œé€‰æ‹©æ–‡ä»¶â€ï¼Œå¯é€šè¿‡å¤šé€‰ä¸Šä¼ ä»»æ„æ•°é‡çš„æ–‡ä»¶ï¼Œéšåç‚¹å‡»â€œä¸Šä¼ â€æŒ‰é’®å³å¯å®Œæˆä¸Šä¼ ã€‚

- **ä¸‹è½½**  
  åœ¨æ–‡ä»¶åˆ—è¡¨ç‚¹å‡»â€œä¸‹è½½â€ï¼Œå³å¯ä¸‹è½½å¯¹åº”æ–‡ä»¶åˆ°æœ¬åœ°ã€‚

- **åˆ é™¤**  
  ç‚¹å‡»â€œåˆ é™¤â€å³å¯åˆ é™¤å¯¹åº”æ–‡ä»¶ï¼Œæ“ä½œæœ‰äºŒæ¬¡ç¡®è®¤ã€‚

- **æµè§ˆåˆ—è¡¨**  
  æ‰€æœ‰å·²ä¸Šä¼ æ–‡ä»¶åœ¨é¡µé¢â€œå·²ä¸Šä¼ æ–‡ä»¶â€æ ä¸­åˆ—å‡ºï¼Œä¾¿äºæŸ¥æ‰¾å’Œç®¡ç†ã€‚









```
from flask import Flask, render_template_string, request, send_from_directory, jsonify
import os, shutil

ROOT_DIR = os.path.abspath("uploads")
os.makedirs(ROOT_DIR, exist_ok=True)

app = Flask(__name__)
app.secret_key = "my_secret_key_123"

HTML = """
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ajax File Manager</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    .file-item, .folder-item { border:1px solid #dee2e6; border-radius:6px; margin:7px 2px; padding:7px 14px; background: #f8f9fa;}
    .folder-item { background: #e3f1ff;}
    .droptarget { border: 2px dashed #0d6efd !important;}
    .dragging { opacity:0.6;}
    .list-group-item {cursor: pointer;}
    .pathbar a {text-decoration:none;}
    .icon-btn {border:none; background:none;}
  </style>
</head>
<body>
<div class="container mt-4">
  <h3 class="mb-4">Ajax File Manager</h3>
  <nav class="mb-3 pathbar">
    <strong>Path:</strong>
    {% for i, seg in enumerate(path_segments) %}
      <a href=" " onclick="loadPath('{{ seg[1] }}');return false;">{{ seg[0] or 'root' }}</a >
      {% if not loop.last %}<span class="mx-1">/</span>{% endif %}
    {% endfor %}
  </nav>
  <div class="row mb-2">
    <div class="col-sm-6">
      <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="inputFiles" name="files" multiple required class="form-control d-inline-block" style="width:55%;">
        <button type="submit" class="btn btn-primary btn-sm ms-2">Upload</button>
      </form>
    </div>
    <div class="col-sm-3">
      <button onclick="newFolderPrompt();" class="btn btn-outline-secondary btn-sm">New Folder</button>
    </div>
    <div class="col-sm-3">
      <button onclick="refreshFiles();" class="btn btn-outline-info btn-sm">Refresh</button>
    </div>
  </div>
  <div id="alertBox"></div>
  <ul id="fileList" class="list-group mb-5"></ul>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- Globals ---
let currentPath = "{{ req_path }}";
let draggedName = null, draggedType = null;

// --- Ajax Helpers ---
function myAlert(msg, type="primary", delay=1400) {
  let box = document.getElementById('alertBox');
  box.innerHTML = '<div class="alert alert-'+type+'">'+msg+'</div>';
  setTimeout(()=>{box.innerHTML="";},delay);
}
function getList() {
  fetch("/api/list?path=" + encodeURIComponent(currentPath))
  .then(r=>r.json()).then(data => {
    genListHtml(data.files);
    if(data.path !== undefined) currentPath = data.path;
    document.querySelectorAll('.file-item,.folder-item').forEach(addDragEvents);
  });
}
function refreshFiles(){ getList(); }
// --- List/Render ---
function genListHtml(files) {
  let list = document.getElementById('fileList');
  if(files.length === 0) {
    list.innerHTML = "<li class='list-group-item'>Empty Folder</li>";
    return;
  }
  list.innerHTML = "";
  for(let f of files){
    let li = document.createElement("li");
    li.className = (f.type=='folder'?"folder-item":"file-item")+" list-group-item d-flex align-items-center";
    li.setAttribute("data-name", f.name);
    li.setAttribute("data-type", f.type);

    if(f.type==="folder") {
      // Folders: click enter, right buttons...
      li.innerHTML = `<span class='me-auto' onclick='loadPath("${makePath(currentPath, f.name)}")'><b>ğŸ“ ${f.name}</b></span>
        <button class='icon-btn ms-2' onclick='delEntry("${f.name}","folder")'><span class="text-danger">ğŸ—‘ï¸</span></button>`;
      // Drag events
    }else{
      li.innerHTML = `<span class='me-auto'>ğŸ“„ ${f.name}</span>
        <a href="/api/download?path=${encodeURIComponent(makePath(currentPath, f.name))}">
           <button class='icon-btn'>â¬‡ï¸</button>
        </a >
        <button class='icon-btn ms-2' onclick='delEntry("${f.name}","file")'><span class="text-danger">ğŸ—‘ï¸</span></button>`;
    }
    list.appendChild(li);
  }
}

// --- Navigation ---
function makePath(p1, name){ return (p1?(p1+"/"):"")+name; }
function loadPath(p) {
  fetch("/api/list?path=" + encodeURIComponent(p)).then(r=>r.json()).then(data=>{
    if(data.error) { myAlert("Cannot access!","danger"); return; }
    currentPath = data.path;    // update current
    genListHtml(data.files);
    // Pathbar
    let bar = document.querySelector('.pathbar'); bar.innerHTML = `<strong>Path:</strong> `;
    data.path_segments.forEach((t,i) => {
      let html = `<a href='#' onclick='loadPath("${t[1]}");return false;'>${t[0]||'root'}</a >`;
      bar.innerHTML += html;
      if(i<data.path_segments.length-1) bar.innerHTML += "<span class='mx-1'>/</span>";
    });
    document.querySelectorAll('.file-item,.folder-item').forEach(addDragEvents);
  });
}

// --- Ajax upload ---
document.getElementById("uploadForm").onsubmit = function(e){
  e.preventDefault();
  let fd = new FormData();
  let files = document.getElementById("inputFiles").files;
  if(!files.length) return myAlert("Please select file(s)","warning");
  for(let f of files) fd.append('files', f);
  fd.append('path', currentPath);
  fetch("/api/upload", {
    method:'POST', body: fd
  })
  .then(r=>r.json()).then(r=>{
    myAlert(r.msg, r.ok?"success":"danger");
    if(r.ok) refreshFiles();
  });
  document.getElementById("uploadForm").reset();
}

// --- New Folder (Prompt via Ajax) ---
function newFolderPrompt(){
  let f = prompt("Folder Name:");
  if(!f) return;
  fetch("/api/mkdir", {
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({path:currentPath, folder_name:f})
  }).then(r=>r.json()).then(data=>{
    myAlert(data.msg, data.ok?"success":"danger"); refreshFiles();
  });
}

// --- Delete Entry (Ajax) ---
function delEntry(fn, typ){
  if(!confirm(`Delete ${typ} "${fn}"?`)) return;
  fetch("/api/delete",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({path: currentPath, name: fn, type: typ})
  }).then(r=>r.json()).then(data=>{
    myAlert(data.msg, data.ok?"success":"danger"); refreshFiles();
  });
}
// ---- Drag & Drop for Move ----
function addDragEvents(li){
  li.draggable = true;
  li.addEventListener('dragstart', e=>{
    draggedName = li.getAttribute('data-name');
    draggedType = li.getAttribute('data-type');
    li.classList.add('dragging');
  });
  li.addEventListener('dragend', e=>{li.classList.remove("dragging");});
  // Only folders as drop targets
  if(li.getAttribute('data-type')==="folder"){
    li.addEventListener('dragover', e => { e.preventDefault(); li.classList.add("droptarget");});
    li.addEventListener('dragleave', e => { li.classList.remove("droptarget"); });
    li.addEventListener('drop', e=>{
      li.classList.remove("droptarget");
      if(!draggedName || draggedName===li.getAttribute('data-name')) return;
      if(!confirm(`Move "${draggedName}" into "${li.getAttribute('data-name')}" ?`))return;
      fetch("/api/move",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          path: currentPath,
          name: draggedName,
          type: draggedType,
          target: li.getAttribute('data-name')
        })
      }).then(r=>r.json()).then(data=>{
        myAlert(data.msg, data.ok?"success":"danger");
        refreshFiles();
      });
    });
  }
}
window.onload = ()=>{ getList(); }
</script>
</body>
</html>
"""

# ------- Utilities -------
def safe_join(base, path):
    final = os.path.abspath(os.path.join(base, path.strip("/")))
    if not final.startswith(base): raise Exception("Unsafe path")
    return final

def to_segments(req_path):
    segs = [('', '')]
    arr = [n for n in req_path.strip('/').split('/') if n]
    for i, seg in enumerate(arr):
        segs.append((seg, '/'.join(arr[:i+1])))
    return segs

# ------ API Routes --------
@app.route("/")
def index():
    req_path = request.args.get("path","")
    return render_template_string(HTML, req_path=req_path, path_segments=to_segments(req_path))

@app.route("/api/list")
def api_list():
    my_path = request.args.get("path", "").strip("/")
    abs_dir = safe_join(ROOT_DIR, my_path)
    if not os.path.exists(abs_dir): return jsonify(error="Path not found", files=[])
    files = []
    for n in sorted(os.listdir(abs_dir)):
        if n.startswith('.'): continue
        full = os.path.join(abs_dir, n)
        typ = "folder" if os.path.isdir(full) else "file"
        files.append({"name":n, "type":typ})
    return jsonify(files=files, path=my_path, path_segments=to_segments(my_path))

@app.route("/api/upload", methods=["POST"])
def api_upload():
    try:
        my_path = request.form.get("path", "").strip("/")
        abs_dir = safe_join(ROOT_DIR, my_path)
        os.makedirs(abs_dir, exist_ok=True)
        files = request.files.getlist("files")
        if not files: return jsonify(ok=False, msg="No file(s).")
        for f in files:
            if f.filename: f.save(os.path.join(abs_dir, f.filename))
        return jsonify(ok=True, msg="Upload success")
    except Exception as e:
        return jsonify(ok=False, msg="Error: "+str(e))

@app.route("/api/mkdir", methods=["POST"])
def api_mkdir():
    data = request.get_json()
    folder_name = data.get("folder_name","").strip("/\\ ")
    if not folder_name: return jsonify(ok=False, msg="Folder name required")
    try:
        new_dir = safe_join(ROOT_DIR, os.path.join(data["path"].strip("/"), folder_name))
        if os.path.exists(new_dir): return jsonify(ok=False, msg="Already exists")
        os.makedirs(new_dir)
        return jsonify(ok=True, msg="Folder created")
    except Exception as e:
        return jsonify(ok=False, msg="Error: "+str(e))

@app.route("/api/delete", methods=["POST"])
def api_delete():
    data = request.get_json()
    entry_name = data.get("name","")
    typ = data.get("type","file")
    path = data.get("path","").strip("/")
    try:
        target = safe_join(ROOT_DIR, os.path.join(path, entry_name))
        if typ == "folder": shutil.rmtree(target)
        else: os.remove(target)
        return jsonify(ok=True, msg="Deleted successfully")
    except Exception as e:
        return jsonify(ok=False, msg=f"Delete failed: {e}")

@app.route("/api/move", methods=["POST"])
def api_move():
    d = request.get_json()
    src = d['name']
    src_typ = d.get("type","file")
    target_f = d['target']
    curr_path = d['path']
    try:
        cur_abs = safe_join(ROOT_DIR, curr_path)
        src_path = os.path.join(cur_abs, src)
        dst_folder = os.path.join(cur_abs, target_f)
        if not os.path.isdir(dst_folder): raise Exception("Target must be folder")
        if src_path == dst_folder: raise Exception("Cannot move into self!")
        new_path = os.path.join(dst_folder, src)
        if os.path.exists(new_path): raise Exception("Target exists!")
        shutil.move(src_path, new_path)
        return jsonify(ok=True, msg="Moved successfully")
    except Exception as e:
        return jsonify(ok=False, msg=f"Move failed: {e}")

@app.route("/api/download")
def api_download():
    my_path = request.args.get("path","").strip("/")
    abs_path = safe_join(ROOT_DIR, my_path)
    if not os.path.isfile(abs_path): return "Not Found",404
    dirn, fn = os.path.dirname(abs_path), os.path.basename(abs_path)
    return send_from_directory(directory=dirn, path=fn, as_attachment=True)

if __name__ == "__main__":
    app.run(debug=True, port=5000)

    ```
